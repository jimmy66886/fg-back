<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zzmr.fgback.mapper.RecipeMapper">

    <!-- 查询RecipeVO，包括基本信息、用料、步骤、点赞数、收藏数 -->
    <resultMap id="RecipeVOResultMap" type="com.zzmr.fgback.vo.RecipeVO">
        <!-- 基本属性映射 -->
        <result property="recipeId" column="recipe_id"/>
        <result property="title" column="title"/>
        <result property="intro" column="intro"/>
        <result property="authorId" column="author_id"/>
        <result property="imageUrl" column="image_url"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="views" column="views"/>
        <!-- 点赞数和收藏数 -->
        <result property="likeNumber" column="like_number"/>
        <result property="favoriteNumber" column="favorite_number"/>

        <!-- 用料列表映射 -->
        <collection property="materials" ofType="com.zzmr.fgback.bean.Materials">
            <id column="materials_id" property="materialsId"/>
            <result property="recipeId" column="recipe_id"/>
            <result property="name" column="name"/>
            <result property="amount" column="amount"/>
        </collection>

        <!-- 菜谱步骤列表映射 -->
        <collection property="recipeSteps" ofType="com.zzmr.fgback.bean.RecipeStep">
            <id column="recipe_step_id" property="recipeStepId"/>
            <result property="stepNumber" column="step_number"/>
            <result property="recipeId" column="recipe_id"/>
            <result property="img" column="img"/>
            <result property="content" column="content"/>
        </collection>

    </resultMap>

    <!-- 查询RecipeVO，包括基本信息、用料、步骤、点赞数、收藏数 -->
    <select id="getRecipeVO" resultMap="RecipeVOResultMap">
        SELECT
            r.recipe_id,
            r.title,
            r.intro,
            r.author_id,
            r.image_url,
            r.create_time,
            r.update_time,
            r.views,
            (
                SELECT COUNT(*) FROM likes WHERE content_id = r.recipe_id AND content_type = 'recipe'
            ) AS like_number,
            (
                SELECT COUNT(*) FROM favorite WHERE recipe_id = r.recipe_id
            ) AS favorite_number,
            m.materials_id,
            m.name,
            m.amount,
            rs.recipe_step_id,
            rs.step_number,
            rs.img,
            rs.content
        FROM recipe r
                 LEFT JOIN materials m ON r.recipe_id = m.recipe_id
                 LEFT JOIN recipe_step rs ON r.recipe_id = rs.recipe_id
        WHERE r.recipe_id = #{recipeId}
    </select>

</mapper>
